"""Prompt æ¨¡æ¿åº“ v2 â€” æ¨èç³»ç»Ÿå¼ç²¾æ’ + æ´å¯Ÿç”Ÿæˆ

æ ¸å¿ƒå‡çº§ï¼š
1. System prompt åŒ…å«ç”¨æˆ·ç”»åƒï¼Œè®© AI ç†è§£å—ä¼—
2. ç²¾æ’ï¼šè¾“å‡ºç»“æ„åŒ–è¯„åˆ†ï¼ˆrelevance/impact/urgencyï¼‰
3. æ´å¯Ÿç”Ÿæˆï¼šä¸åªæ˜¯æ‘˜è¦ï¼Œè¦æœ‰ "so what?"
4. åˆ†çº§æ ‡æ³¨ï¼šğŸ”´å¿…è¯» / ğŸŸ¡æ¨è / ğŸŸ¢äº†è§£
"""


# ============================================================
# ç”¨æˆ·ç”»åƒï¼ˆæ³¨å…¥ system promptï¼‰
# ============================================================
USER_CONTEXT = """ä½ æ­£åœ¨ä¸ºä¸€ä½ç‰¹å®šè¯»è€…ç”Ÿæˆæ¯æ—¥æƒ…æŠ¥ç®€æŠ¥ã€‚

è¯»è€…ç”»åƒï¼š
- èº«ä»½ï¼šAI åº”ç”¨ç®—æ³•å·¥ç¨‹å¸ˆ + åŠ å¯†è´§å¸é‡åŒ–äº¤æ˜“ç ”ç©¶è€…
- AI æ–¹å‘ï¼šä¸“æ³¨ LLM/Agent/RAG ç­‰åº”ç”¨å±‚æŠ€æœ¯ï¼Œå…³æ³¨æ¨¡å‹èƒ½åŠ›è¾¹ç•Œã€å·¥ç¨‹æœ€ä½³å®è·µã€å·¥å…·é“¾æ¼”è¿›
- é‡åŒ–æ–¹å‘ï¼šä¸“æ³¨åŠ å¯†è´§å¸å¸‚åœºçš„é‡åŒ–ç­–ç•¥ï¼ˆå¥—åˆ©ã€åšå¸‚ã€è¶‹åŠ¿è·Ÿè¸ªï¼‰ï¼Œå…³æ³¨é“¾ä¸Šæ•°æ®ã€å¸‚åœºå¾®è§‚ç»“æ„ã€DeFi åè®®
- åå¥½ï¼šæ·±åº¦æŠ€æœ¯å†…å®¹ > æµ…å±‚æ–°é—»ï¼›ä¸€æ‰‹ä¿¡æ¯ > äºŒæ‰‹æŠ¥é“ï¼›å¯æ“ä½œçš„æ´å¯Ÿ > æ³›æ³›çš„è¶‹åŠ¿
- è¯­è¨€ï¼šä¸­æ–‡ä¸ºä¸»ï¼ŒæŠ€æœ¯æœ¯è¯­ä¿ç•™è‹±æ–‡

ä½ çš„è§’è‰²ï¼šä¸æ˜¯å®¢è§‚è®°è€…ï¼Œè€Œæ˜¯è¿™ä½è¯»è€…çš„ç§äººæƒ…æŠ¥åˆ†æå¸ˆã€‚"""


class PromptsV2:
    """v2 Prompt æ¨¡æ¿ â€” ç²¾æ’ + æ´å¯Ÿ"""

    @staticmethod
    def system_prompt() -> str:
        return USER_CONTEXT

    @staticmethod
    def fine_rank_prompt(items: list, section: str) -> str:
        """
        ç²¾æ’ prompt â€” AI è¯„ä¼°æ¯æ¡å†…å®¹çš„ä»·å€¼
        
        è¾“å‡ºï¼šç»“æ„åŒ– JSONï¼Œæ¯æ¡å¸¦ relevance/impact/urgency åˆ†æ•°
        """
        items_text = "\n\n".join([
            f"[{i}] æ ‡é¢˜: {item.title}\n"
            f"æ¥æº: {_get_source(item)} | ç²—æ’åˆ†: {item.score:.1f}\n"
            f"å†…å®¹: {item.text[:600]}"
            for i, item in enumerate(items)
        ])

        return f"""ç²¾æ’ä»»åŠ¡ï¼šä» {section} é¢†åŸŸçš„å€™é€‰å†…å®¹ä¸­ï¼Œè¯„ä¼°æ¯æ¡çš„ä»·å€¼å¹¶æ’åºã€‚

# è¯„åˆ†ç»´åº¦ï¼ˆæ¯é¡¹ 1-10 åˆ†ï¼‰
- **relevance**ï¼šä¸è¯»è€…å…´è¶£çš„ç›¸å…³æ€§ï¼ˆå‚è€ƒè¯»è€…ç”»åƒï¼‰
- **impact**ï¼šå¯¹è¡Œä¸š/å¸‚åœºçš„å½±å“åŠ›ã€ä¿¡æ¯çš„ç‹¬ç‰¹æ€§
- **urgency**ï¼šæ—¶æ•ˆæ€§ï¼Œæ˜¯å¦éœ€è¦ç«‹å³å…³æ³¨

# å€™é€‰å†…å®¹
{items_text}

# è¾“å‡ºè¦æ±‚
1. è¯„ä¼°æ¯æ¡å†…å®¹ï¼Œç»™å‡ºä¸‰ç»´è¯„åˆ†
2. æŒ‰ç»¼åˆä»·å€¼é™åºæ’åˆ—
3. æ·˜æ±°æ˜æ˜¾ä½è´¨é‡çš„å†…å®¹ï¼ˆç»¼åˆåˆ† < 12 çš„ä¸è¦ï¼‰
4. æ ‡æ³¨ä¼˜å…ˆçº§ï¼šğŸ”´(ç»¼åˆâ‰¥24) / ğŸŸ¡(18-23) / ğŸŸ¢(12-17)

```json
[
  {{
    "id": 0,
    "relevance": 8,
    "impact": 9,
    "urgency": 7,
    "total": 24,
    "priority": "ğŸ”´",
    "reason": "ä¸€å¥è¯è¯´æ˜ä¸ºä»€ä¹ˆé‡è¦"
  }}
]
```

åªè¿”å› JSON æ•°ç»„ã€‚"""

    @staticmethod
    def insight_extract_prompt(items: list, section: str) -> str:
        """
        æ´å¯Ÿæå– prompt â€” ç”Ÿæˆå¸¦æ·±åº¦åˆ†æçš„æ—¥æŠ¥æ¡ç›®
        """
        items_text = "\n\n".join([
            f"[{i}] {item.title}\næ¥æº: {_get_source(item)} | é“¾æ¥: {item.url}\næ‘˜è¦: {item.text[:400]}"
            for i, item in enumerate(items)
        ])

        return f"""ä¸º {section} æ¿å—ç”Ÿæˆæ—¥æŠ¥æ¡ç›®ã€‚

# å†…å®¹
{items_text}

# è¾“å‡ºè¦æ±‚
ä¸ºæ¯æ¡ç”Ÿæˆï¼š
- **headline**ï¼šä¸€å¥è¯æ ‡é¢˜ï¼ˆ15-20å­—ï¼Œæ ¸å¿ƒä»·å€¼ï¼‰
- **detail**ï¼š1-2 å¥ï¼Œæ ¸å¿ƒäº‹å® + "æ‰€ä»¥å‘¢ï¼Ÿ"
- **priority**ï¼šğŸ”´å¿…è¯» / ğŸŸ¡æ¨è / ğŸŸ¢äº†è§£
- **tags**ï¼š1-2 ä¸ªæ ‡ç­¾

é£æ ¼ï¼šè¯´äººè¯ï¼Œæœ‰åˆ¤æ–­åŠ›ï¼Œæœ¯è¯­ä¿ç•™è‹±æ–‡ï¼Œæ•°æ®è¦å…·ä½“ã€‚

```json
[{{"headline":"æ ‡é¢˜","detail":"äº‹å®+æ„ä¹‰","url":"é“¾æ¥","source":"æ¥æº","priority":"ğŸ”´","tags":["#æ ‡ç­¾"]}}]
```

åªè¿”å› JSONã€‚"""

    @staticmethod
    def executive_summary_prompt(all_briefs: dict, section_configs: dict) -> str:
        """
        Executive Summary prompt â€” 30 ç§’è¯»å®Œä»Šæ—¥æ ¸å¿ƒ
        """
        sections_text = ""
        for section, briefs in all_briefs.items():
            if not briefs:
                continue
            meta = section_configs.get(section, {})
            emoji = meta.get("emoji", "â€¢")
            title = meta.get("title", section)
            # åªå–æ¯ä¸ª section çš„ top 3
            top_briefs = briefs[:3]
            items_summary = "\n".join([
                f"  - [{b.get('priority', 'ğŸŸ¢')}] {b.get('headline', '')} ({b.get('source', '')})"
                for b in top_briefs
            ])
            sections_text += f"\n{emoji} {title}:\n{items_summary}\n"

        return f"""åŸºäºä»Šæ—¥å„æ¿å—çš„ç²¾é€‰å†…å®¹ï¼Œç”Ÿæˆä¸€ä»½ Executive Summaryã€‚

# ä»Šæ—¥å†…å®¹æ¦‚è§ˆ
{sections_text}

# è¾“å‡ºè¦æ±‚
ç”Ÿæˆ 3-5 ä¸ª bullet points çš„ Executive Summaryï¼š
1. æ¯ä¸ª bullet å¯¹åº”ä»Šå¤©æœ€é‡è¦çš„ä¸€ä¸ªäº‹ä»¶/è¶‹åŠ¿
2. è·¨æ¿å—å…³è”ï¼šå¦‚æœ AI å’Œ Crypto æ¿å—æœ‰ç›¸å…³çš„äº‹ä»¶ï¼Œåˆå¹¶è¯´
3. ä¼˜å…ˆçº§æ’åºï¼šæœ€é‡è¦çš„æ”¾æœ€å‰é¢
4. é£æ ¼ï¼šåƒç»™è€æ¿çš„è¯­éŸ³å¤‡å¿˜å½•ä¸€æ ·ç®€æ´ç›´æ¥

æ ¼å¼ï¼š
```
â€¢ [æœ€é‡è¦çš„äº‹] â€” ä¸€å¥è¯è¯´æ˜ + ä¸ºä»€ä¹ˆé‡è¦
â€¢ [ç¬¬äºŒé‡è¦çš„äº‹] â€” ...
â€¢ [è¶‹åŠ¿æ´å¯Ÿ] â€” å¦‚æœå‘ç°äº†ä»€ä¹ˆè·¨é¢†åŸŸçš„è¶‹åŠ¿
```

åªè¿”å› bullet points æ–‡æœ¬ã€‚"""


def _get_source(item) -> str:
    """è·å–äººç±»å¯è¯»çš„æ¥æºå"""
    meta = getattr(item, 'metadata', {}) or {}
    return meta.get('feed_name') or meta.get('feed_title') or getattr(item, 'source', 'unknown')
