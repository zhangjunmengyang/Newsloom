"""Prompt æ¨¡æ¿åº“ v2 â€” æ¨èç³»ç»Ÿå¼ç²¾æ’ + æ´å¯Ÿç”Ÿæˆ

æ ¸å¿ƒå‡çº§ï¼š
1. System prompt åŒ…å«ç”¨æˆ·ç”»åƒï¼Œè®© AI ç†è§£å—ä¼—
2. ç²¾æ’ï¼šè¾“å‡ºç»“æ„åŒ–è¯„åˆ†ï¼ˆrelevance/impact/urgencyï¼‰
3. æ´å¯Ÿç”Ÿæˆï¼šä¸åªæ˜¯æ‘˜è¦ï¼Œè¦æœ‰ "so what?"
4. åˆ†çº§æ ‡æ³¨ï¼šğŸ”´å¿…è¯» / ğŸŸ¡æ¨è / ğŸŸ¢äº†è§£
"""


# ============================================================
# ç”¨æˆ·ç”»åƒï¼ˆæ³¨å…¥ system promptï¼‰
# ============================================================
USER_CONTEXT = """ä½ æ­£åœ¨ä¸ºä¸€ä½ç‰¹å®šè¯»è€…ç”Ÿæˆæ¯æ—¥æƒ…æŠ¥ç®€æŠ¥ã€‚

è¯»è€…ç”»åƒï¼š
- èº«ä»½ï¼šAI åº”ç”¨ç®—æ³•å·¥ç¨‹å¸ˆ + åŠ å¯†è´§å¸é‡åŒ–äº¤æ˜“ç ”ç©¶è€…
- AI æ–¹å‘ï¼šä¸“æ³¨ LLM/Agent/RAG ç­‰åº”ç”¨å±‚æŠ€æœ¯ï¼Œå…³æ³¨æ¨¡å‹èƒ½åŠ›è¾¹ç•Œã€å·¥ç¨‹æœ€ä½³å®è·µã€å·¥å…·é“¾æ¼”è¿›
- é‡åŒ–æ–¹å‘ï¼šä¸“æ³¨åŠ å¯†è´§å¸å¸‚åœºçš„é‡åŒ–ç­–ç•¥ï¼ˆå¥—åˆ©ã€åšå¸‚ã€è¶‹åŠ¿è·Ÿè¸ªï¼‰ï¼Œå…³æ³¨é“¾ä¸Šæ•°æ®ã€å¸‚åœºå¾®è§‚ç»“æ„ã€DeFi åè®®
- åå¥½ï¼šæ·±åº¦æŠ€æœ¯å†…å®¹ > æµ…å±‚æ–°é—»ï¼›ä¸€æ‰‹ä¿¡æ¯ > äºŒæ‰‹æŠ¥é“ï¼›å¯æ“ä½œçš„æ´å¯Ÿ > æ³›æ³›çš„è¶‹åŠ¿
- è¯­è¨€ï¼šä¸­æ–‡ä¸ºä¸»ï¼ŒæŠ€æœ¯æœ¯è¯­ä¿ç•™è‹±æ–‡

ä½ çš„è§’è‰²ï¼šä¸æ˜¯å®¢è§‚è®°è€…ï¼Œè€Œæ˜¯è¿™ä½è¯»è€…çš„ç§äººæƒ…æŠ¥åˆ†æå¸ˆã€‚

æ ¸å¿ƒè¦æ±‚ï¼ˆæ¯æ¡å¿…é¡»æ»¡è¶³ï¼‰ï¼š
1. **so-what å¼ºåˆ¶**ï¼šæ¯æ¡æƒ…æŠ¥å¿…é¡»åŒ…å«"å¯¹è¯»è€…çš„å…·ä½“å½±å“/å†³ç­–ä»·å€¼"ï¼Œä¸åªæ˜¯è½¬è¿°äº‹å®
2. **åˆ¤æ–­ä¸æ˜¯æ¬è¿**ï¼šç”¨è‡ªå·±çš„åˆ†æè¯´"ä¸ºä»€ä¹ˆé‡è¦"ï¼Œä¸åªæ˜¯"å‘ç”Ÿäº†ä»€ä¹ˆ"
3. **è¡ŒåŠ¨å¯¼å‘**ï¼šå°½é‡è¯´æ˜è¯»è€…åº”è¯¥åšä»€ä¹ˆã€å…³æ³¨ä»€ä¹ˆã€è§„é¿ä»€ä¹ˆ
4. **ä¿¡å· vs å™ªéŸ³**ï¼šä¸»åŠ¨è¯†åˆ«å¹¶è¿‡æ»¤è¥é”€ç¨¿ã€AIç”Ÿæˆæ°´æ–‡ã€SEOåƒåœ¾å†…å®¹"""


class PromptsV2:
    """v2 Prompt æ¨¡æ¿ â€” ç²¾æ’ + æ´å¯Ÿ"""

    @staticmethod
    def system_prompt() -> str:
        return USER_CONTEXT

    @staticmethod
    def fine_rank_prompt(items: list, section: str) -> str:
        """
        ç²¾æ’ prompt â€” AI è¯„ä¼°æ¯æ¡å†…å®¹çš„ä»·å€¼
        
        è¾“å‡ºï¼šç»“æ„åŒ– JSONï¼Œæ¯æ¡å¸¦ relevance/impact/urgency åˆ†æ•°
        """
        items_text = "\n\n".join([
            f"[{i}] æ ‡é¢˜: {item.title}\n"
            f"æ¥æº: {_get_source(item)} | ç²—æ’åˆ†: {item.score:.1f}\n"
            f"å†…å®¹: {item.text[:600]}"
            for i, item in enumerate(items)
        ])

        return f"""ç²¾æ’ä»»åŠ¡ï¼šä» {section} é¢†åŸŸçš„å€™é€‰å†…å®¹ä¸­ï¼Œè¯„ä¼°æ¯æ¡çš„ä»·å€¼å¹¶æ’åºã€‚

# è¯„åˆ†ç»´åº¦ï¼ˆæ¯é¡¹ 1-10 åˆ†ï¼‰
- **relevance**ï¼šä¸è¯»è€…å…´è¶£çš„ç›¸å…³æ€§ï¼ˆå‚è€ƒè¯»è€…ç”»åƒï¼‰
- **impact**ï¼šå¯¹è¡Œä¸š/å¸‚åœºçš„å½±å“åŠ›ã€ä¿¡æ¯çš„ç‹¬ç‰¹æ€§
- **urgency**ï¼šæ—¶æ•ˆæ€§ï¼Œæ˜¯å¦éœ€è¦ç«‹å³å…³æ³¨

# å€™é€‰å†…å®¹
{items_text}

# è¾“å‡ºè¦æ±‚
1. è¯„ä¼°æ¯æ¡å†…å®¹ï¼Œç»™å‡ºä¸‰ç»´è¯„åˆ†
2. æŒ‰ç»¼åˆä»·å€¼é™åºæ’åˆ—
3. æ·˜æ±°æ˜æ˜¾ä½è´¨é‡çš„å†…å®¹ï¼ˆç»¼åˆåˆ† < 12 çš„ä¸è¦ï¼‰
4. æ ‡æ³¨ä¼˜å…ˆçº§ï¼šğŸ”´(ç»¼åˆâ‰¥24) / ğŸŸ¡(18-23) / ğŸŸ¢(12-17)

```json
[
  {{
    "id": 0,
    "relevance": 8,
    "impact": 9,
    "urgency": 7,
    "total": 24,
    "priority": "ğŸ”´",
    "reason": "ä¸€å¥è¯è¯´æ˜ä¸ºä»€ä¹ˆé‡è¦"
  }}
]
```

åªè¿”å› JSON æ•°ç»„ã€‚"""

    @staticmethod
    def insight_extract_prompt(items: list, section: str) -> str:
        """
        æ´å¯Ÿæå– prompt â€” ç”Ÿæˆå¸¦æ·±åº¦åˆ†æçš„æ—¥æŠ¥æ¡ç›®ï¼ˆso-what å¼ºåˆ¶ï¼‰
        """
        items_text = "\n\n".join([
            f"[{i}] {item.title}\næ¥æº: {_get_source(item)} | é“¾æ¥: {item.url}\næ‘˜è¦: {item.text[:400]}"
            for i, item in enumerate(items)
        ])

        return f"""ä¸º {section} æ¿å—ç”Ÿæˆæ—¥æŠ¥æ¡ç›®ã€‚

# å†…å®¹
{items_text}

# è¾“å‡ºæ ¼å¼
ä¸ºæ¯æ¡ç”Ÿæˆ JSON å¯¹è±¡ï¼š
- **headline**ï¼šä¸€å¥è¯æ ‡é¢˜ï¼ˆ15-25å­—ï¼‰ï¼Œç›´æ¥è¯´æ ¸å¿ƒä»·å€¼ï¼Œä¸æ˜¯æ–°é—»æ ‡é¢˜çš„å¤åˆ¶
- **detail**ï¼š2-3 å¥ã€‚ç¬¬ä¸€å¥æ˜¯æ ¸å¿ƒäº‹å®ï¼ˆæ•°æ®è¦å…·ä½“ï¼‰ï¼›ç¬¬äºŒå¥æ˜¯**so-what**ï¼Œå³"è¿™å¯¹è¯»è€…æ„å‘³ç€ä»€ä¹ˆã€å½±å“å“ªä¸ªå†³ç­–ã€éœ€è¦æ€ä¹ˆå“åº”"ï¼›å¯é€‰ç¬¬ä¸‰å¥æ˜¯èƒŒæ™¯æˆ–é£é™©æç¤º
- **so_what**ï¼šå•ç‹¬æå–çš„è¡ŒåŠ¨/å†³ç­–å»ºè®®ï¼ˆ10-20å­—ï¼‰ï¼Œå¦‚"ç«‹å³è¯„ä¼°ä¾›åº”å•†æ›¿ä»£æ–¹æ¡ˆ"ã€"å…³æ³¨é“¾ä¸Šå¤§é¢è½¬ç§»ä¿¡å·"
- **priority**ï¼šğŸ”´å¿…è¯»ï¼ˆç›´æ¥å½±å“å†³ç­–ï¼‰ / ğŸŸ¡æ¨èï¼ˆä»Šå¤©åº”çŸ¥ï¼‰ / ğŸŸ¢äº†è§£ï¼ˆèƒŒæ™¯ä¿¡æ¯ï¼‰
- **tags**ï¼š1-2 ä¸ªç²¾å‡†æ ‡ç­¾

é£æ ¼è§„èŒƒï¼š
- è¯´äººè¯ï¼Œæœ‰ç«‹åœºï¼ŒæŠ€æœ¯æœ¯è¯­ä¿ç•™è‹±æ–‡
- æ•°å­—è¦å…·ä½“ï¼ˆä¸è¯´"å¤§å¹…å¢é•¿"ï¼Œè¦è¯´"+73%"ï¼‰
- è¿‡æ»¤æ‰æ²¡æœ‰å®è´¨å†…å®¹çš„æ¡ç›®ï¼ˆå¦‚"Xå…¬å¸å®£å¸ƒå°†åœ¨æœªæ¥æ¢ç´¢AI"ï¼‰
- ä¸»åŠ¨è¯†åˆ«ï¼šè¿™æ˜¯ä¿¡å·è¿˜æ˜¯å™ªéŸ³ï¼Ÿ
- æ—¶æ•ˆæ€§æ ¸æŸ¥ï¼šå¯¹AIæ¨¡å‹ç‰ˆæœ¬å·ã€äº§å“å‘å¸ƒç­‰å¿«é€Ÿè¿­ä»£é¢†åŸŸï¼Œåˆ¤æ–­æ˜¯å¦å·²è¢«æ›´æ–°ç‰ˆæœ¬è¦†ç›–ï¼ˆå¦‚å½“å‰å·²æ˜¯GLM-5ï¼ŒæŠ¥é“GLM-4.7åˆ™é™çº§å¹¶æ³¨æ˜ï¼‰ï¼›æ—§é—»ç›´æ¥è¿‡æ»¤

```json
[{{"headline":"æ ‡é¢˜","detail":"äº‹å®ã€‚so-whatåˆ†æã€‚","so_what":"è¡ŒåŠ¨å»ºè®®","url":"é“¾æ¥","source":"æ¥æº","priority":"ğŸ”´","tags":["#æ ‡ç­¾"]}}]
```

åªè¿”å› JSON æ•°ç»„ã€‚"""

    @staticmethod
    def executive_summary_prompt(all_briefs: dict, section_configs: dict) -> str:
        """
        Executive Summary prompt â€” 30 ç§’è¯»å®Œä»Šæ—¥æ ¸å¿ƒ + è·¨æ¿å—å…³è”å‘ç°
        """
        sections_text = ""
        for section, briefs in all_briefs.items():
            if not briefs or section.startswith('__'):
                continue
            meta = section_configs.get(section, {})
            emoji = meta.get("emoji", "â€¢")
            title = meta.get("title", section)
            top_briefs = briefs[:4]
            items_summary = "\n".join([
                f"  - [{b.get('priority', 'ğŸŸ¢')}] {b.get('headline', '')} | so-what: {b.get('so_what', '')}"
                for b in top_briefs
            ])
            sections_text += f"\n{emoji} {title}:\n{items_summary}\n"

        return f"""åŸºäºä»Šæ—¥å„æ¿å—ç²¾é€‰æƒ…æŠ¥ï¼Œç”Ÿæˆ Executive Summary + è·¨æ¿å—å…³è”åˆ†æã€‚

# ä»Šæ—¥å„æ¿å—å†…å®¹
{sections_text}

# è¾“å‡ºè¦æ±‚

## Part 1: æ ¸å¿ƒè¦ç‚¹ï¼ˆ3-5æ¡ï¼‰
æ¯æ¡å¯¹åº”ä»Šå¤©æœ€é‡è¦çš„äº‹ä»¶/è¶‹åŠ¿ï¼Œæ ¼å¼ï¼š
â€¢ **[äº‹ä»¶æ ¸å¿ƒ]** â€” äº‹å® + ä¸ºä»€ä¹ˆè¿™å¯¹è¯»è€…é‡è¦ + å»ºè®®è¡ŒåŠ¨

ä¼˜å…ˆçº§è§„åˆ™ï¼š
- ğŸ”´ ç›´æ¥å½±å“èµ„äº§/å†³ç­–çš„æ”¾æœ€å‰é¢
- è·¨ AI + Crypto çš„äº¤å‰äº‹ä»¶ï¼ˆå¦‚"AIæ¨åŠ¨DeFiæ–°èµ›é“"ï¼‰å•ç‹¬æç‚¼æˆä¸€æ¡
- ä¸æ˜¯é‡è¦æ€§çš„æ’åˆ—ï¼Œæ˜¯å†³ç­–ç›¸å…³æ€§çš„æ’åˆ—

## Part 2: è·¨æ¿å—å…³è”ï¼ˆå¦‚æœæœ‰ï¼‰
æ‰¾å‡ºä»Šæ—¥ä¸åŒæ¿å—ä¹‹é—´çš„éšæ€§å…³è”ï¼Œæ ¼å¼ï¼š
ğŸ”— **[å…³è”æ´å¯Ÿ]** â€” [æ¿å—Aäº‹ä»¶] + [æ¿å—Bäº‹ä»¶] â†’ å…±åŒæŒ‡å‘çš„è¶‹åŠ¿æˆ–é£é™©

ä¾‹å¦‚ï¼šAIæ¨¡å‹æ•ˆç‡çªç ´ + Cryptoé“¾ä¸ŠAIåè®®TVLä¸Šæ¶¨ â†’ AIÃ—DeFièµ›é“æ­£åœ¨åŠ é€Ÿ

## Part 3: ä»Šæ—¥ä¿¡å·è¯„çº§
ç”¨ä¸€å¥è¯æ€»ç»“ä»Šæ—¥ä¿¡æ¯å¯†åº¦ï¼š
ğŸ“Š ä»Šæ—¥è¯„çº§ï¼š[ğŸ”´é«˜å¯†åº¦/ğŸŸ¡ä¸­ç­‰/ğŸŸ¢å¹³æ·¡] â€” [ä¸€å¥è¯åŸå› ]

åªè¿”å›çº¯æ–‡æœ¬ï¼Œä¸è¦ JSONã€‚"""

    @staticmethod
    def cross_section_analysis_prompt(all_briefs: dict) -> str:
        """
        è·¨æ¿å—æ·±åº¦å…³è”åˆ†æ â€” å‘ç°éšæ€§è¿æ¥
        """
        briefs_text = ""
        for section, briefs in all_briefs.items():
            if not briefs or section.startswith('__'):
                continue
            top = briefs[:5]
            headlines = [b.get('headline', '') for b in top]
            briefs_text += f"\nã€{section}ã€‘: " + " | ".join(headlines)

        return f"""åˆ†æä»¥ä¸‹ä»Šæ—¥å„æ¿å—çš„æƒ…æŠ¥æ ‡é¢˜ï¼Œæ‰¾å‡ºè·¨æ¿å—çš„éšæ€§å…³è”å’Œè¶‹åŠ¿ä¿¡å·ã€‚

{briefs_text}

ä»»åŠ¡ï¼š
1. æ‰¾å‡º 2-4 ä¸ªè·¨æ¿å—å…³è”ï¼ˆä¸åŒ section çš„äº‹ä»¶æŒ‡å‘åŒä¸€åº•å±‚è¶‹åŠ¿ï¼‰
2. è¯†åˆ«ä»Šæ—¥ä¸»å™äº‹çº¿ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
3. æ ‡æ³¨æ½œåœ¨çš„é£é™©/æœºä¼šäº¤å‰ç‚¹

è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š
```json
{{
  "cross_connections": [
    {{
      "sections": ["ai", "crypto"],
      "insight": "å…³è”æ´å¯Ÿï¼ˆä¸€å¥è¯ï¼‰",
      "implication": "å¯¹è¯»è€…çš„å½±å“ï¼ˆå†³ç­–ç›¸å…³ï¼‰"
    }}
  ],
  "main_narrative": "ä»Šæ—¥ä¸»å™äº‹çº¿ï¼ˆå¦‚æœæœ‰ï¼Œå¦åˆ™nullï¼‰",
  "risk_opportunity": "æœ€å€¼å¾—å…³æ³¨çš„é£é™©æˆ–æœºä¼šï¼ˆä¸€å¥è¯ï¼‰"
}}
```

åªè¿”å› JSONã€‚"""


def _get_source(item) -> str:
    """è·å–äººç±»å¯è¯»çš„æ¥æºå"""
    meta = getattr(item, 'metadata', {}) or {}
    return meta.get('feed_name') or meta.get('feed_title') or getattr(item, 'source', 'unknown')
